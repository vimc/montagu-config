# montagu-config

Config and scripts for deploying Montagu.

The basic idea here is that **all** configuration for the various components of montagu will end up here, separated by machine at present.  This leads to a little duplication between machines, which is not ideal, but we can revisit that later.

The components currently described are:

* `montagu.yml`: Deployment of the montagu core (api, admin and contribution portal, db, etc)
* `packit.yml`: Deployment of the reporting portal (packit and its runners)
* `privateer.json`: Backup and restore of the orderly volume, restoration of the database
* `diagnostic-reports.yml`: Automatic diagnostic reports (autogenerated)

Historically relevant information will be found in:

* [`montagu-orderly-web`](https://github.com/vimc/montagu-orderly-web); old configuration for orderly web. This will be present for a while at least
* [`montagu`](https://github.com/vimc/montagu)
* [`montagu-db-backup`](https://github.com/vimc/montagu-db-backup)
* [`starport`](https://github.com/vimc/starport)

and other places that we'll collect here.

We are aiming to progressively streamline this process.

This document is a bit long and rambly while we have OrderlyWeb deployed and are in the middle of migration, but will be thinned down once the migration is complete.

All commands below here are run from the `montagu-config/` directory within the machine you are working with, after [`ssh`-ing into the appropriate machine](https://mrc-ide.myjetbrains.com/youtrack/articles/RESIDE-A-5/Accessing-servers)

# Pre-deployment scripts

Diagnostic report config is committed to this repo, but if you need to change it, it can be re-generated by running `scripts/generate_real_diagnostic_reports_config.py`.
This will generate a new yaml file "diagnostic-reports.yml" in the current working directory, which can then be copied into place in the relevant instance config directory.

# Preparation

We require some python packages: `montagu-deploy`, `packit-deploy` and `privateer`.  All are available on PyPI and can be installed with `pip3 install --user package-name`.  We'll set up a `pyproject.toml` or `requirements.txt` for this repo at some point in the future which will streamline things.

Be aware that attempting installing with `pip` is not always sufficient for it to actually install anything, as it may decide that the old version you have is fine and then not actually do anything.  You can resolve this by specifying a version (`pip3 install --user montagu-deploy==0.1.2`), uninstalling first `pip3 uninstall --user montagu-deploy`) or by passing `--force` (though this reinstalls *everything*).

You can find out what versions of things you have by running

```
montagu-deploy --version
packit-deploy --version
privateer --version
```

If you are developing the deploy tools, you might like to run `hatch build` on the source tree and then copy the resulting `.whl` file to the machine you are working on.  You can then install that package:

```
pip3 install --user packit_deploy-0.0.11-py3-none-any.whl
```

Again, watch out to see if `pip` actually installs this, and be particularly careful if you have not changed the version number.

## OrderlyWeb

The orderly-web-deploy tool is not currently updated on PyPI, so install that from source.

# Migration of old packets

We've removed the old orderly-to-packit migration, so this needs to be run manually.

Try a migration with:

```
docker pull mrcide/outpack.orderly:main
docker run -it --rm --name outpack-migrate \
    -v montagu_orderly_volume:/orderly:ro \
    -v outpack_volume:/outpack \
    mrcide/outpack.orderly:main \
    /orderly /outpack --once
```

Or schedule recurring migrations with

```
docker run --rm -d --name outpack-migrate \
    -v montagu_orderly_volume:/orderly:ro \
    -v outpack_volume:/outpack \
    mrcide/outpack.orderly:main \
    /orderly /outpack --minutes=5
```

On production, I have run

```
docker pull mrcide/outpack.orderly:main
docker run -it --rm --name outpack-migrate \
    -v montagu_orderly_volume:/orderly:ro \
    -v montagu_outpack_volume:/outpack \
    mrcide/outpack.orderly:main \
    /orderly /outpack --once
```

which took about 2 hours from scratch.

# Deployment

On a first deployment (after bringing down all containers), the order matters.  You need to bring up `packit` (and `OrderlyWeb` if you are using that) *before* `montagu`, otherwise the proxy will fail to start.

If you get a gateway error causing packit login to fail, redeploy montagu (or have a go just restarting the proxy container). This can happen if you redeploy packit without subsequently restarting montagu.

Assuming `uat` here:

Start OrderlyWeb from `montagu-orderly-web/` with:

```
./start
```

```
packit start --pull uat
montagu start --pull uat
```

Replace `uat` with `science` or `production` on those machines.

See https://github.com/vimc/montagu-deploy for more details on the deploy tool.

# First-time deployment

The first time that montagu is deployed on a machine (or after removing data volumes) additional work is required:

## Create an initial admin user

On the first deployment for a machine you will not have an admin user in Packit, which is problematic.  You can promote a user to admin in Packit after they've logged in to Montagu by running

```
./scripts/promote-packit-user u.name@imperial.ac.uk
```



## Update the packages for the runner

The runner library volume (`orderly_library`) will need required packages installed.  Do this by running

```
docker run --rm -v orderly_library:/library -v $PWD/packages:/packages:ro -w /packages mrcide/orderly.runner:main ./install_packages
```

See [`packages/README.md`](packages/README.md) for more information.

## Update the data vis tool

After deploying both Montagu and Packit, you will need to copy the data viz tools into place.  This requires that Packit is deployed, but only needs to be redone after montagu is deployed.

```
./scripts/copy-vis-tool
```

# Interacting with packit

Redeploy packit (e.g., after making a change); stop and start the containers using `packit-deploy`.  You probably want the `--kill` argument to swiftly but rudely bring down containers and the `--pull` argument to make sure that you get the most recent copy of containers to deploy.

```
packit stop --kill uat
packit start --pull uat
```

Be sure to get the machine name correct (`uat`, `science` or `production`).

If you want to test a branch, you will first need to adapt the build_montagu_packit_front_end.yml workflow from [packit](https://github.com/mrc-ide/packit) so that it runs for your branch. Then, after that image is pushed, you should return to the relevant machine (most likely you'll be doing this on `uat`) and edit the appropriate `tag:` field(s) within `uat/packit.yml`. You can do this with a local change on the machine, e.g. with `vim` or `nano` or by making a branch in `montagu-config`, depending on the complexity of the changes. 

# Automatic certificate renewal

If automatic certificates are enabled, you should run the `renew-certificate` the first time you deploy montagu to get the initial certificate.

    montagu renew-certificate <path>

This command will need to be run periodically to ensure the certificate stays up-to-date. This is done by installing a systemd timer, using the provided `install-timer.sh` script.

    ./scripts/install-timer.sh <path>

# Interacting with orderly-web

When migrating over from `orderly-web` you may need to bring down an older version of OrderlyWeb (e.g., by running `./stop` from within `montagu-orderly-web`.  However, the serialised configuration is incompatible with newer versions of `orderly-web-deploy` and `constellation`.  The safest fix is to create a virtual environment and work there:

```
cd montagu-orderly-web
python3 -m venv old-ow
. ./old-ow/bin/activate
pip3 install constellation==1.2.4 orderly-web==1.0.0
./stop
deactivate
```

Once brought down with the old version, you can then use the globally installed version of `orderly-web`.

# Backup and restore

See [`backup.md`](backup.md) for details on this process.  See [`rebuild.md`](rebuild.md) for an account of rebuilding the systems in 2025.


To interact with the backups (key generation, backup, restore, etc) you will need `privateer2` installed.  Currently do this by installing manually from the sources (`hatch build`, copy the whl file around then `pip3 install --user <path>`). Once we merge back into `privateer`, you can install from pypi with pip:

```
pip3 install --user privateer
```

Before any backup and restore is possible, you would have first needed to create keys:

```
privateer2 keygen --all
```

Each machine that uses privateer needs to be configured; this is `annex` and `annex2` (the servers) and `production`, `production2`, `science` and `uat`. This pulls keys from the vault and writes out persistent ssh configuration.

## Backup

We don't yet support scheduled backups, so everything is manual for now.

```
privateer2 backup production montagu_orderly_volume --server=annex
privateer2 backup production montagu_orderly_volume --server=annex2
```

## Restore

```
privateer2 restore production montagu_orderly_volume --server=annex
```

on science this would be

```
privateer2 restore production montagu_orderly_volume --server=annex --source=production
```

See https://github.com/reside-ic/privateer2 for more details on the backup tool.
